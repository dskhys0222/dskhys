name: Setup SSL Certificate

on:
  workflow_dispatch:
    inputs:
      use_staging:
        description: 'Use Let''s Encrypt staging environment (to avoid rate limits)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: read

jobs:
  setup-ssl:
    name: Setup SSL Certificate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            deployment/compose.yaml
            deployment/nginx/nginx.conf

      - name: Setup SSL on server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
          LETSENCRYPT_EMAIL: ${{ secrets.LETSENCRYPT_EMAIL }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p "${SSH_PORT:-22}" "$SSH_HOST" >> ~/.ssh/known_hosts
          trap 'rm -f ~/.ssh/deploy_key' EXIT

          # Create deploy directory
          ssh -i ~/.ssh/deploy_key -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" "mkdir -p ${DEPLOY_PATH}/nginx"

          # Copy files to server
          scp -i ~/.ssh/deploy_key -P "${SSH_PORT:-22}" \
            deployment/compose.yaml \
            "${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}/"

          scp -i ~/.ssh/deploy_key -P "${SSH_PORT:-22}" \
            deployment/nginx/nginx.conf \
            "${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}/nginx/"

          # Replace domain placeholder and verify nginx config
          ssh -i ~/.ssh/deploy_key -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" "
            set -x
            cd ${DEPLOY_PATH}/nginx
            
            echo '=== Before replacement ==='
            grep 'ssl_certificate' nginx.conf | head -2 || echo 'Pattern not found'
            
            sed -i 's/\\\${DOMAIN_NAME}/${DOMAIN_NAME}/g' nginx.conf
            
            echo '=== After replacement ==='
            grep 'ssl_certificate' nginx.conf | head -2
            
            echo '=== Check if DOMAIN_NAME variable still exists ==='
            grep 'DOMAIN_NAME' nginx.conf || echo 'No DOMAIN_NAME variable found (good)'
          "

          # Update .env file (update existing keys or add new ones)
          ssh -i ~/.ssh/deploy_key -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" "
            cd ${DEPLOY_PATH}
            touch .env
            
            # Update DOMAIN_NAME
            if grep -q '^DOMAIN_NAME=' .env; then
              sed -i 's|^DOMAIN_NAME=.*|DOMAIN_NAME=${DOMAIN_NAME}|' .env
            else
              echo 'DOMAIN_NAME=${DOMAIN_NAME}' >> .env
            fi
            
            # Update LETSENCRYPT_EMAIL
            if grep -q '^LETSENCRYPT_EMAIL=' .env; then
              sed -i 's|^LETSENCRYPT_EMAIL=.*|LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}|' .env
            else
              echo 'LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}' >> .env
            fi
          "

          # Create dummy certificate for initial nginx startup
          ssh -i ~/.ssh/deploy_key -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" "
            cd ${DEPLOY_PATH}
            
            # Remove any existing certificates to avoid -0001 suffix issue
            docker compose run --rm --entrypoint '' certbot sh -c '
              rm -rf /etc/letsencrypt/live/${DOMAIN_NAME}*
              rm -rf /etc/letsencrypt/archive/${DOMAIN_NAME}*
              rm -rf /etc/letsencrypt/renewal/${DOMAIN_NAME}*.conf
              mkdir -p /etc/letsencrypt/live/${DOMAIN_NAME}
              openssl req -x509 -nodes -newkey rsa:2048 -days 1 \
                -keyout /etc/letsencrypt/live/${DOMAIN_NAME}/privkey.pem \
                -out /etc/letsencrypt/live/${DOMAIN_NAME}/fullchain.pem \
                -subj \"/CN=localhost\"
            '
          "

          # Start nginx with dummy cert (pull images first, start only nginx)
          ssh -i ~/.ssh/deploy_key -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" "
            cd ${DEPLOY_PATH}
            docker compose pull nginx certbot
            
            echo '=== Testing nginx configuration ==='
            docker compose run --rm --no-deps --entrypoint '' nginx nginx -t -c /etc/nginx/nginx.conf || echo 'Config test failed, continuing...'
            
            echo '=== Checking nginx.conf ACME challenge location ==='
            grep -A 2 'location /.well-known/acme-challenge/' ${DEPLOY_PATH}/nginx/nginx.conf || echo 'ACME location not found'
            
            docker compose up -d --no-deps nginx
            sleep 5
            
            echo '=== Container Status ==='
            docker compose ps
            
            echo '=== Nginx Logs ==='
            docker compose logs nginx
            
            echo '=== Port 80 Check ==='
            ss -tlnp | grep :80 || netstat -tlnp | grep :80 || echo 'Port 80 not listening'
            
            echo '=== Check certbot-www volume mount ==='
            docker compose exec nginx ls -la /var/www/certbot || echo 'Volume not accessible'
            
            echo '=== Check nginx.conf inside container ==='
            docker compose exec nginx cat /etc/nginx/nginx.conf | grep -A 3 'location /.well-known/acme-challenge/'
            
            echo '=== Create test file directly ==='
            docker compose exec nginx sh -c 'echo "test-content" > /var/www/certbot/direct-test && ls -la /var/www/certbot/' || echo 'Cannot write to volume (read-only is expected)'
            
            echo '=== Test nginx config syntax ==='
            docker compose exec nginx nginx -t
            
            echo '=== Test Local Access ==='
            curl -v http://localhost/.well-known/acme-challenge/test-file 2>&1 || echo 'Local curl failed'
          "

          # Obtain certificate
          USE_STAGING="${{ github.event.inputs.use_staging }}"
          ssh -i ~/.ssh/deploy_key -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" "
            cd ${DEPLOY_PATH}
            
            echo '=== Removing existing certificates completely ==='
            docker compose run --rm --entrypoint '' certbot sh -c '
              rm -rf /etc/letsencrypt/live/${DOMAIN_NAME}*
              rm -rf /etc/letsencrypt/archive/${DOMAIN_NAME}*
              rm -rf /etc/letsencrypt/renewal/${DOMAIN_NAME}*.conf
              ls -la /etc/letsencrypt/live/ || echo \"Live directory cleared\"
            '
            
            echo '=== Obtaining certificate (staging='"${USE_STAGING}"') ==='
            STAGING_FLAG=''
            if [ '"${USE_STAGING}"' = 'true' ]; then
              STAGING_FLAG='--staging'
              echo 'Using Let'\''s Encrypt STAGING environment (test certificates)'
            else
              echo 'Using Let'\''s Encrypt PRODUCTION environment (real certificates)'
            fi
            
            docker compose run --rm certbot certonly \\
              --webroot \\
              --webroot-path=/var/www/certbot \\
              --email '"${LETSENCRYPT_EMAIL}"' \\
              --agree-tos \\
              --no-eff-email \\
              --cert-name '"${DOMAIN_NAME}"' \\
              \$STAGING_FLAG \\
              -d '"${DOMAIN_NAME}"'
          "

          # Reload nginx with real certificate
          ssh -i ~/.ssh/deploy_key -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" "
            cd ${DEPLOY_PATH}
            
            echo '=== Verifying certificate files exist ==='
            docker compose exec nginx ls -la /etc/letsencrypt/live/
            
            echo '=== Testing nginx configuration before reload ==='
            docker compose exec nginx nginx -t || echo 'Config test failed'
            
            echo '=== Reloading nginx ==='
            docker compose exec nginx nginx -s reload
          "

          # Setup certificate renewal cron
          ssh -i ~/.ssh/deploy_key -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" "
            (crontab -l 2>/dev/null | grep -v 'certbot renew'; echo \"0 */12 * * * cd ${DEPLOY_PATH} && docker compose run --rm certbot renew --quiet && docker compose exec nginx nginx -s reload\") | crontab -
          "

          echo "SSL setup completed successfully!"

