# 要件定義書：マネーフォワード連携（ポートフォリオ銘柄自動取得）

## 概要

マネーフォワードのポートフォリオページからスクレイピングで銘柄データを自動取得し、**暗号化してサーバーに保存**。Portfolio アプリから取得・**復号して表示**するシステムを構築する。

## システム構成

```txt
┌─────────────────────────────────────────────────────────────────┐
│ ローカル PC（Linux）                                            │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │ スクレイピング  │───▶│ 暗号化処理      │                    │
│  │ バッチ          │    │ (AES-256-GCM)   │                    │
│  └─────────────────┘    └────────┬────────┘                    │
│         ▲                        │                             │
│         │                        ▼                             │
│  ┌──────┴──────────┐    ┌─────────────────┐                    │
│  │ マネーフォワード│    │ API 送信        │                    │
│  │ (Playwright)    │    │ (暗号化データ)  │                    │
│  └─────────────────┘    └────────┬────────┘                    │
└──────────────────────────────────┼─────────────────────────────┘
                                   │ HTTPS
                                   ▼
┌─────────────────────────────────────────────────────────────────┐
│ VPS サーバー                                                    │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │ REST API        │───▶│ SQLite          │                    │
│  │ (登録/取得)     │    │ (暗号化データ)  │                    │
│  └─────────────────┘    └─────────────────┘                    │
└──────────────────────────────────┬─────────────────────────────┘
                                   │ HTTPS
                                   ▼
┌─────────────────────────────────────────────────────────────────┐
│ Portfolio アプリ（ブラウザ）                                    │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │ API 取得        │───▶│ 復号処理        │───▶ 表示           │
│  │ (暗号化データ)  │    │ (AES-256-GCM)   │                    │
│  └─────────────────┘    └─────────────────┘                    │
└─────────────────────────────────────────────────────────────────┘
```

## セキュリティ設計

### 暗号化方式

- **アルゴリズム**: AES-256-GCM（認証付き暗号）
- **鍵長**: 256 ビット
- **IV（初期化ベクトル）**: 12 バイト（毎回ランダム生成）
- **認証タグ**: 16 バイト

### 暗号化キーの管理

| 保管場所         | キーの形式     | 用途   |
| ---------------- | -------------- | ------ |
| ローカル PC      | 設定ファイル   | 暗号化 |
| Portfolio アプリ | ユーザー入力   | 復号   |
| VPS サーバー     | **保管しない** | -      |

### データフロー

1. **ローカル PC**: 平文データ → 暗号化 → サーバーに送信
2. **サーバー**: 暗号化データをそのまま保存（復号不可）
3. **Portfolio アプリ**: 暗号化データ取得 → ユーザーがキー入力 → 復号 → 表示

## 要件 ID・要件名

| ID      | 要件名                                | 優先度 |
| ------- | ------------------------------------- | ------ |
| REQ-001 | マネーフォワード自動ログイン機能      | 必須   |
| REQ-002 | TOTP 対応のセッション管理             | 必須   |
| REQ-003 | 銘柄データのスクレイピング            | 必須   |
| REQ-004 | データの暗号化（AES-256-GCM）         | 必須   |
| REQ-005 | API 提供（登録エンドポイント）        | 必須   |
| REQ-006 | API 提供（取得エンドポイント）        | 必須   |
| REQ-007 | 1 日 1 回の定期実行バッチ（ローカル） | 必須   |
| REQ-008 | Portfolio アプリでの復号・表示        | 必須   |
| REQ-009 | エラーハンドリング・通知              | 推奨   |

---

## 詳細要件

### REQ-001: マネーフォワード自動ログイン機能

**説明：** Playwright を使用してマネーフォワードに自動ログインする機能

**詳細：**

- マネーフォワード URL：`https://moneyforward.com/`
- ユーザー ID/パスワード：環境変数から取得
- タイムアウト：30 秒以内にログイン完了
- ブラウザ：Chromium ヘッドレスモード

**入出力：**

- 入力：ユーザー ID、パスワード
- 出力：認証済みのブラウザコンテキスト

---

### REQ-002: TOTP 対応のセッション管理

**説明：** TOTP（Time-based One-Time Password）による 2 要素認証に対応

**詳細：**

- TOTP 秘密鍵：環境変数 `MF_TOTP_SECRET` から取得
- 初回実行時：
  - ブラウザで手動で 2FA コード入力
  - セッション情報を `auth.json` に保存
- 2 回目以降：
  - 保存済みセッションから再開
  - ログイン画面をスキップ

**ファイル保存先：**

- ローカル PC のセキュアな場所（`~/.config/mf-scraper/auth.json`）
- パーミッション: `600`（所有者のみ読み書き可）
- `.gitignore` に追加

**セッション有効期限：**

- 基本は永続
- 有効期限切れ時は再度手動実行が必要

---

### REQ-003: 銘柄データのスクレイピング

**説明：** マネーフォワードのポートフォリオページから銘柄情報を抽出

**取得対象データ：**

- 銘柄名
- 保有数
- 平均取得単価
- 基準価額
- 評価額
- 評価損益
- 保有金融機関

**スクレイピング対象ページ：**

- `https://moneyforward.com/bs/portfolio`（ポートフォリオページ）

**要件：**

- タイムアウト：60 秒以内に取得完了
- 要素検出失敗時：エラーログ + スキップ
- 複数回リトライ：最大 3 回まで

---

### REQ-004: データの暗号化（AES-256-GCM）

**説明：** スクレイピングデータを暗号化してからサーバーに送信

**暗号化仕様：**

- アルゴリズム: AES-256-GCM
- キー: 設定ファイル `~/.config/mf-scraper/config.json` から取得（32 バイト）
- IV: 12 バイト（毎回ランダム生成）
- 認証タグ: 16 バイト

**暗号化対象データ：**

```json
{
  "stocks": [
    {
      "name": "銘柄名",
      "units": 100,
      "averageCost": 1500,
      "currentPrice": 1600,
      "value": 160000,
      "profitLoss": 10000,
      "account": "SBI証券"
    }
  ],
  "scrapedAt": "2026-01-13T15:30:00Z"
}
```

**暗号化後のフォーマット：**

```json
{
  "iv": "base64エンコードされたIV",
  "data": "base64エンコードされた暗号文",
  "tag": "base64エンコードされた認証タグ"
}
```

---

### REQ-005: API 提供（登録エンドポイント）

**説明：** ローカル PC からサーバーに暗号化データを登録するエンドポイント

**エンドポイント設計：**

```txt
POST /api/portfolio/encrypted
  認証：必須（JWT）
  リクエストボディ：
  {
    "iv": "base64エンコードされたIV",
    "data": "base64エンコードされた暗号文",
    "tag": "base64エンコードされた認証タグ",
    "scrapedAt": "2026-01-13T15:30:00Z"
  }
  レスポンス：
  {
    "success": true,
    "message": "Data saved successfully"
  }
```

**要件：**

- 認証済みユーザーのみ登録可能
- 既存データは上書き（1 ユーザー 1 レコード）
- スクレイピング日時を別カラムに保存（検索用）

---

### REQ-006: API 提供（取得エンドポイント）

**説明：** Portfolio アプリから暗号化データを取得するエンドポイント

**エンドポイント設計：**

```txt
GET /api/portfolio/encrypted
  認証：必須（JWT）
  レスポンス：
  {
    "iv": "base64エンコードされたIV",
    "data": "base64エンコードされた暗号文",
    "tag": "base64エンコードされた認証タグ",
    "scrapedAt": "2026-01-13T15:30:00Z",
    "updatedAt": "2026-01-13T15:30:00Z"
  }
```

**要件：**

- 認証済みユーザーのデータのみ返却
- データが存在しない場合は 404

---

### REQ-007: 1 日 1 回の定期実行バッチ（ローカル PC）

**説明：** ローカル PC で 1 日 1 回、指定時刻にバッチを自動実行

**実行スケジュール：**

- 実行時刻：毎日 午前 7 時（JST）
- 実行周期：24 時間

**実装方法：**

- systemd timer または cron を使用
- または `node-cron` でバックグラウンド実行

**処理フロー：**

1. セッション情報（auth.json）確認
2. セッション有効期限確認（有効期限切れ時はスキップ + 通知）
3. マネーフォワードにアクセス
4. 銘柄データスクレイピング
5. データを AES-256-GCM で暗号化
6. サーバー API に送信
7. 実行ログ記録

---

### REQ-008: Portfolio アプリでの復号・表示

**説明：** 取得した暗号化データを復号して Portfolio アプリで表示

**復号フロー：**

1. ユーザーが暗号化キーを入力（初回のみ、以降はローカルストレージに保存）
2. サーバーから暗号化データを取得
3. Web Crypto API で復号
4. 復号したデータを表示

**表示場所：**

- 既存のポートフォリオ一覧画面
- マネーフォワード連携データの区別表示（例：バッジ「MF 連携」）

**要件：**

- 復号失敗時はエラーメッセージ表示
- キーが間違っている場合は再入力を促す
- 更新日時の表示

---

### REQ-009: エラーハンドリング・通知

**説明：** エラー発生時の処理と管理者への通知

**エラーケース：**

- ログイン失敗（認証情報の誤り、2FA 失敗など）
- セッション有効期限切れ
- スクレイピング失敗（ページ構造変更など）
- データベース保存失敗
- ネットワークエラー

**対応：**

- エラーログ記録（サーバーログ）
- メール/Slack 通知（推奨）
- リトライロジック（最大 3 回）

---

## 非機能要件

| 項目                 | 要件                                                           |
| -------------------- | -------------------------------------------------------------- |
| **セキュリティ**     | E2E 暗号化、サーバーは復号不可、認証情報はローカル PC のみ保管 |
| **パフォーマンス**   | バッチ実行時間：5 分以内                                       |
| **可用性**           | セッション有効期限切れ時は手動再実行                           |
| **保守性**           | マネーフォワード UI 変更に対応可能な設計                       |
| **スケーラビリティ** | 1 ユーザー対応（個人利用）                                     |

---

## 制約事項

1. **マネーフォワード利用規約**

   - スクレイピングが禁止されていないことを確認
   - 規約違反時は中止

2. **セッション有効期限**

   - 初回セッション保存後、有効期限切れまで自動実行可能
   - 期限切れ時は手動で再度ログイン → セッション更新

3. **ページ構造への依存性**

   - マネーフォワード の UI 変更時に対応が必要
   - CSS セレクタの定期確認

4. **暗号化キーの管理**

   - ローカル PC と Portfolio アプリで同一キーを使用
   - キー紛失時はデータ復号不可（再スクレイピング必要）

5. **バッチ実行環境**
   - ローカル PC（Linux）が起動している必要あり
   - ネットワーク接続が必要

---

## スケジュール・進め方

1. **仕様書作成** - 実装設計、DB 設計、API 定義
2. **テストコード作成** - ユニットテスト、統合テスト
3. **実装**
   - バッチ処理ロジック
   - スクレイピング機能
   - API 実装
   - Portfolio アプリ連携
4. **テスト・デバッグ**
5. **本番デプロイ**

---

## 参考情報

- 既存サーバー構成：`docs/specifications/deployment/system-architecture.md`
- 既存ポートフォリオアプリ仕様：`docs/specifications/portfolio/app-specification.md`
