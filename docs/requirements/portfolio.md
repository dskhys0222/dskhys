# 要件定義：株式ポートフォリオ管理アプリ（Portfolio）

## 目的

保有している株式銘柄の情報を一元管理し、スマートフォンから簡単にポートフォリオ状況を確認できるようにする。

## 対象範囲

- クライアント：`packages/client/portfolio`（新規作成）

## 機能要件

### 1. 銘柄データの管理

#### 1.1 銘柄情報の入力・編集

- 以下の情報を入力・保存できる：
  - 銘柄（必須）：銘柄名
  - ティッカー（必須）：ティッカーシンボル（例：ACWI、VTI）
  - 評価額（必須）：現在の評価額
  - 口数（任意）：保有口数
  - 平均取得単価（任意）：1 口あたりの平均取得単価
  - クラス（必須）：以下から選択
    - 現金
    - 株式
    - コモディティ
  - 地域（必須）：以下から選択
    - 日本
    - 米国
    - 全世界
  - 属性（必須）：以下から選択
    - 現金
    - インデックス
    - 増配
    - ゴールド
    - 暗号通貨
  - 口座（必須）：以下から選択
    - 預金
    - 特定
    - NISA
    - DC
    - 暗号資産
  - 備考（任意）：自由記述

#### 1.2 銘柄データの一覧表示

- 保有銘柄を一覧表示
- ソート機能（評価額など）
- フィルタ機能（クラス、地域、属性、口座など）

### 2. 集計・分析機能

#### 2.1 評価額の集計

- 各銘柄の評価額を表示
- 合計評価額を表示
- 各カラム（クラス、地域、属性、口座）ごとの評価額集計

#### 2.2 各種サマリービュー

- クラス別集計
- 地域別集計
- 属性別集計
- 口座別集計

### 3. ビジュアライゼーション（グラフ表示）

#### 3.1 クラス別アロケーション（ドーナツグラフ）

- クラス（現金、株式、コモディティ）ごとの評価額配分を表示
- 各クラスの比率をパーセンテージで表示

#### 3.2 地域別アロケーション（ドーナツグラフ）

- 地域（日本、米国、全世界）ごとの評価額配分を表示
- 各地域の比率をパーセンテージで表示

#### 3.3 属性別アロケーション（ドーナツグラフ）

- 属性（現金、インデックス、増配、ゴールド、暗号通貨）ごとの評価額配分を表示
- 各属性の比率をパーセンテージで表示

#### 3.4 口座別アロケーション（ドーナツグラフ）

- 口座（預金、特定、NISA、DC、暗号資産）ごとの評価額配分を表示
- 各口座の比率をパーセンテージで表示

### 4. データ永続化

- ローカルストレージにデータを保存
- PWA としてオフラインでも利用可能

### 5. データのインポート/エクスポート

- JSON 形式でのデータエクスポート
- JSON 形式でのデータインポート
- バックアップ・復元機能

### 6. マネーフォワード連携

#### 6.1 データ取得・復号化（完了）

- API サーバーから暗号化されたポートフォリオデータを取得 ✅
- クライアント側で復号化して表示 ✅
- 暗号化キーはクライアント設定で管理 ✅
- AES-256-GCM による E2E 暗号化 ✅

#### 6.2 銘柄管理（完了）

- 銘柄を `source` フィールドで分類 ✅
  - `source='manual'`: ユーザーが手動で入力した銘柄
  - `source='mf'`: マネーフォワード同期銘柄
- MF 銘柄は完全自動同期（追加・更新・削除） ✅
- 手動銘柄は MF 同期の影響を受けない ✅

#### 6.3 データ反映（完了）

- ホーム画面の「更新」ボタンで MF 銘柄を同期 ✅
- 設定画面でログイン・ログアウト実施 ✅
- 最終更新日時と MF 銘柄数を表示 ✅
- 同期完了時に成功メッセージ表示（5 秒自動消去） ✅

#### 6.4 マッピング戦略（完了）

- MFStock の `id` を使用して重複登録を防止 ✅
- 初回同期：mfStock.id で Stock 作成
- 再同期：同じ ID の Stock を更新
- ユーザー設定値の保護：ticker, assetClass, region, attribute, account は上書きしない ✅

## 前提・制約

- 基本的にローカルで動作する PWA
- マネーフォワード連携機能のみ API サーバーと通信
- 株価の自動取得機能は含まない（マネーフォワード連携で評価額を取得）
- 初期リリースでは日本語 UI のみ

## 非機能要件

### パフォーマンス

- 100 銘柄程度の管理でも快適に動作すること
- グラフの描画は 1 秒以内に完了すること

### ユーザビリティ

- スマートフォンでの操作を最優先に設計
- タブレットでも見やすいレスポンシブデザイン
- 直感的な UI/UX

### セキュリティ

- ローカルストレージのデータは暗号化しない（ローカル専用のため）
- マネーフォワードデータは E2E 暗号化で通信
- 暗号化キーはクライアント側で安全に管理

### 保守性

- budget プロジェクトと同様の技術スタックを使用
- コンポーネントの再利用性を考慮

## 画面構成（完了）

1. **ホーム画面（ダッシュボード）** ✅

   - サマリー情報表示：総評価額、総評価損益
   - 各種ドーナツグラフ表示（クラス別、地域別、属性別、口座別）
   - 「銘柄を追加」ボタン
   - 「更新」ボタン（MF データ同期用）

2. **銘柄一覧画面** ✅

   - 保有銘柄のリスト表示
   - ソート・フィルタ機能
   - 各銘柄の評価額、口数、損益表示

3. **銘柄追加/編集画面** ✅

   - 銘柄情報の入力フォーム
   - 全フィールド入力サポート（備考欄も含む）

4. **集計画面** ✅

   - クラス別・地域別・属性別・口座別の集計表示
   - 合計評価額
   - 総評価損益（利益は緑、損失は赤で表示）

5. **設定画面** ✅

   - データのインポート/エクスポート
   - マネーフォワード連携設定
     - ログイン/ログアウト
     - 最終更新日時・登録銘柄数表示
     - API URL 設定
     - 暗号化キー設定

6. **マネーフォワード同期機能** ✅
   - 同期ページ削除（ホーム画面の「更新」ボタンに統合）
   - ワンクリック同期：「更新」ボタンで自動的に MF 銘柄を追加・更新・削除

## データモデル

### 銘柄（Stock）

| フィールド名 | 型     | 必須 | 説明                                             |
| ------------ | ------ | ---- | ------------------------------------------------ |
| id           | string | ○    | 一意識別子（UUID または MFStockId）              |
| source       | enum   | ○    | 'manual' \| 'mf' (マネーフォワード同期)          |
| name         | string | ○    | 銘柄名                                           |
| ticker       | string | ○    | ティッカーシンボル                               |
| value        | number | ○    | 評価額                                           |
| units        | number | -    | 口数                                             |
| averageCost  | number | -    | 平均取得単価                                     |
| currentPrice | number | -    | 現在価格（基準価額）                             |
| assetClass   | enum   | ○    | クラス（現金/株式/コモディティ）                 |
| region       | enum   | ○    | 地域（日本/米国/全世界）                         |
| attribute    | enum   | ○    | 属性（現金/インデックス/増配/ゴールド/暗号通貨） |
| account      | enum   | ○    | 口座（預金/特定/NISA/DC/暗号資産）               |
| note         | string | -    | 備考                                             |
| createdAt    | string | ○    | 作成日時                                         |
| updatedAt    | string | ○    | 更新日時                                         |

### 列挙型定義

```typescript
// クラス
type AssetClass = "現金" | "株式" | "コモディティ";

// 地域
type Region = "日本" | "米国" | "全世界";

// 属性
type Attribute = "現金" | "インデックス" | "増配" | "ゴールド" | "暗号通貨";

// 口座
type Account = "預金" | "特定" | "NISA" | "DC" | "暗号資産";
```

## 参考

- 既存プロジェクト：`packages/client/budget`
- スプレッドシートのレイアウトを参考に UI 設計を行う
