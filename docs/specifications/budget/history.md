# 仕様：履歴機能（Budget）

対象：`packages/client/budget` の `/` ルート（`BudgetItem`："モノ" / "コト"）および履歴ページ

## ルーティング

- トップページ：`/`
- 履歴ページ：`/history/$name`
  - `$name` は `BudgetItem` の `name`（例："モノ" / "コト"）を表す

## 画面構成

### トップページ（`/`）

- `BudgetItem` の操作ボタン
  - `+`（増額）
  - `-`（減額）
  - `履歴`（履歴ページへ遷移）

### 履歴ページ（`/history/$name`）

- タイトル：`履歴`
- 対象表示：`$name`（例："モノ" / "コト"）
- 一覧：履歴エントリ（新しい順）
- 戻る操作：`戻る` ボタン

## データモデル

履歴エントリ（表示・永続化の最小単位）

- `id: string`
  - エントリ識別子（同一配列内で一意）
- `at: string`
  - 記録日時（ISO 8601 文字列）
- `kind: 'increase' | 'decrease'`
  - 操作種別
- `delta: number`
  - 差分金額（正の整数）
- `after: number`
  - 操作後の金額

## 状態

### トップページ

- `amount: number`
  - 現在金額
- `dialogMode: 'increase' | 'decrease' | null`
  - 表示中ダイアログ（増減のみ）
- `deltaAmountInput: string`
  - 増減入力値
- `hasHydratedFromStorage: boolean`
  - `localStorage` 復元完了フラグ（永続化の二重書き防止）

### 履歴ページ

- `name: string`
  - ルートパラメータ `$name`
- `historyEntries: HistoryEntry[]`
  - 対象 `BudgetItem` の履歴

## 永続化（localStorage）

### 金額

- 既存仕様どおり、キーは `BudgetItem` の `name` をそのまま使用する

### 履歴

- 履歴は金額と別キーで保持する
- 永続化キー：`budget:history:${name}`
  - 例："モノ" → `budget:history:モノ`
  - 例："コト" → `budget:history:コト`
- 保存値：`HistoryEntry[]` を `JSON.stringify` した文字列
- 復元時の扱い
  - 値が存在しない場合：空配列 `[]`
  - JSON でない / 期待形式でない場合：空配列 `[]`

### 件数上限

- なし（保存期限は無制限）

## 操作フロー

### 履歴表示

1. ユーザーが `履歴` ボタンを押下
2. 履歴ページ（`/history/$name`）へ遷移する
3. 履歴が 0 件の場合は空表示（例：`履歴はありません`）を表示する
4. 戻る操作（戻るボタン）でトップページへ戻る

### 履歴記録（増額/減額確定時）

1. ユーザーが `+` または `-` を押下し、差分金額を入力
2. `確定` 押下でバリデーションを通過した場合に `amount` を更新する
3. 同じ確定処理内で履歴を 1 件追加する
   - `kind`：増額なら `increase`、減額なら `decrease`
   - `delta`：入力差分
   - `after`：更新後の `amount`
   - `at`：確定時刻
   - `id`：確定時刻と乱数等から生成（衝突しない範囲で十分）
4. ダイアログを閉じ、入力をリセットする

### キャンセル

- キャンセル操作（キャンセルボタン、Esc 等）で増減ダイアログを閉じる
- `amount` は変更しない
- 履歴は追加しない
- 入力はリセットする

## 表示仕様

- `amount` は既存どおり `￥` + 3 桁区切りで表示する
- 履歴エントリは以下の情報を 1 行（または 1 ブロック）で表現する
  - 日時（ユーザーのロケールで可読表示）
  - 操作種別（増額/減額）
  - 差分金額（`+` / `-` を付けて可視化してよい）
  - 操作後金額

## アクセシビリティ

- 履歴ページは、ページタイトル等により現在地が判別できる
- 戻るボタンは `aria-label` 等により意図が判別できる
