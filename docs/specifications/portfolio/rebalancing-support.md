# リバランス支援機能

## 概要

ポートフォリオのリバランスを支援するため、各カスタム集計で理想比を設定し、現在の金額との差額を可視化する機能。

## 機能

### 1. 理想比の設定

**編集画面での入力**:

- カスタム集計の編集・新規作成画面で、各属性に「理想比」を入力できる
- 入力欄の仕様：
  - 数値入力フィールド（0以上、上限なし）
  - 小数第1位まで対応（step: 0.1）
  - 任意入力（理想比を設定しない属性も可能）
  - 例：5項目に対して各1を入力 → 各20%が理想割合（1÷(1+1+1+1+1)=20%）

**データ構造**:

- `CustomAggregationAttribute` に `targetRatio?: number` フィールド（比の値）
- `AggregatedData` に以下フィールドを追加：
  - `targetRatio?: number` - 理想比（パーセント以外の比の値）
  - `difference?: number` - 差額：現在の金額 - 理想金額（円）

### 2. 差額の計算と表示

**差額の計算式**:

```txt
理想比率合計 = 全属性の targetRatio の合計
各属性の理想金額 = 総額 × (各属性の targetRatio / 理想比率合計)
difference = 現在の金額 - 理想金額
```

**例：**

- 総額: ¥1,000,000
- コアの理想比: 3、サテライトの理想比: 2
- 理想比率合計: 5
- コアの理想金額: ¥1,000,000 × (3/5) = ¥600,000
- サテライトの理想金額: ¥1,000,000 × (2/5) = ¥400,000
- 現在のコア金額: ¥650,000、差額: +¥50,000
- 現在のサテライト金額: ¥350,000、差額: -¥50,000

**表示方法の分岐**:

#### PC表示（デスクトップ）

理想比を設定している場合、テーブルに以下のカラムを表示：

1. 項目名
2. 金額
3. **差額（金額）** ← 新規追加カラム（¥単位）
4. 比率（%）

#### スマホ表示（モバイル）

理想比を設定している場合、以下の機能を提供：

**表示切り替えボタン**:

- 「差額表示」「比率表示」を切り替えられるボタンを表示
- デフォルト：比率表示
- ボタン配置：編集・削除ボタンの間

**表示モード**:

- **比率表示モード：** 通常通り比率（%）を表示
- **差額表示モード：** 差額（金額）を表示
  - 正の値：`+¥50,000`
  - 負の値：`¥50,000`（絶対値表示）

### 3. UI配置

#### PCレイアウト

```txt
[集計タイトル]
┌────────────────────────────────────────────┐
│                                            │ [編集]
│  ドーナツグラフ                            │ [削除]
│                                            │
│                                            │
├─────────────┬──────────┬──────────┬────────┤
│  コア       │ ¥650,000 │ +¥50,000 │ 65.0%  │
│  サテライト │ ¥350,000 │ -¥50,000 │ 35.0%  │
├─────────────┼──────────┼──────────┼────────┤
│  合計       │¥1,000,000│   -      │100.0%  │
└─────────────┴──────────┴──────────┴────────┘
```

#### スマホレイアウト

```txt
[集計タイトル]

┌─────────────────────────────────┐
│                                 │ [編集]
│      ドーナツグラフ             │ [削除]
│                                 │ [切替]
│                                 │
├─────────────┬──────────┬────────┤
│  コア       │ ¥650,000 │ 65.0%  │
│  サテライト │ ¥350,000 │ 35.0%  │
├─────────────┼──────────┼────────┤
│  合計       │¥1,000,000│100.0%  │
└─────────────┴──────────┴────────┘

差額表示モード：
├─────────────┬──────────┬─────────┤
│  コア       │ ¥650,000 │ +50,000 │
│  サテライト │ ¥350,000 │ -50,000 │
├─────────────┼──────────┼─────────┤
│  合計       │¥1,000,000│   -     │
└─────────────┴──────────┴─────────┘
```

## 実装の詳細

### 修正したファイル

1. **src/types/index.ts**
   - `AggregatedData` の `difference` を金額型（number）に変更
   - コメントを更新

2. **src/components/DonutChart.tsx**
   - `DonutChartProps` に `showDifference` と `displayMode` を追加
   - テーブルにtheadを追加してヘッダーを表示
   - displayModeに応じた差額/比率の表示切り替え
   - 差額を `formatCurrency()` で金額表示に

3. **src/routes/summary/new.tsx & $id/edit.tsx**
   - 属性設定フォームの理想比入力欄
   - プレースホルダーを「理想比」に変更
   - max属性を削除（上限なし）

4. **src/routes/summary/index.tsx**
   - `aggregateCustom()` で差額を金額で計算
   - 理想比から理想金額を算出する処理を追加
   - スマホ用の表示モード管理状態（`displayModes`）を追加
   - 差額表示ボタンの条件付き表示

5. **src/routes/summary/index.styles.ts**
   - `toggleButton` スタイルを追加
   - 既存ボタンの配置調整

## 使用例

### 1. 新規カスタム集計の作成

1. 「カスタム集計を追加」をクリック
2. 集計名を入力（例：「コア・サテライト」）
3. 属性を設定：
   - 属性名：「コア」、理想比：「3」
   - 属性名：「サテライト」、理想比：「2」
4. 銘柄を各属性に割り当て
5. 保存

### 2. 差額の確認

- PC表示：テーブルの「差額」カラムで現在と理想の乖離を金額で確認
- スマホ表示：「差額表示」ボタンで比率と差額を切り替えて確認

## 技術仕様

### 状態管理

`displayModes` 状態：

```typescript
const [displayModes, setDisplayModes] = useState<
  Record<string, "percentage" | "difference">
>({});
```

### 計算ロジック

```typescript
// 理想比率合計を計算
const totalRatio = aggregation.attributes.reduce(
  (sum, a) => sum + (a.targetRatio || 0),
  0,
);

// 理想金額を計算
const targetValue = (total * targetRatio) / totalRatio;

// 差額（金額）を計算
const difference = value - targetValue;
```

### 条件付きレンダリング

- 理想比が設定されている属性のみ差額情報を計算・表示
- `hasTargetRatios` フラグで表示モード切り替えボタンの表示/非表示を制御
