# 認証フロー

本ドキュメントでは、システムの認証関連のフローを説明します。

## 概要

認証方式にはJWT（JSON Web Token）を使用します。

- **アクセストークン**: 短期間有効（例：15分）
- **リフレッシュトークン**: 長期間有効（例：7日）

## 1. 会員登録フロー

ユーザーが新規アカウントを作成する際のフローです。

```mermaid
sequenceDiagram
    actor User as ユーザー
    participant Client as クライアント
    participant API as APIサーバー
    participant DB as データベース

    User->>Client: 登録情報入力<br/>(名前、メール、パスワード)
    Client->>Client: バリデーション
    Client->>API: POST /api/auth/register<br/>{name, email, password}
    
    API->>API: 入力検証
    API->>DB: メールアドレス重複チェック
    
    alt メールアドレスが既に存在
        DB-->>API: 重複あり
        API-->>Client: 400 Bad Request<br/>{error: "Email already exists"}
        Client-->>User: エラー表示
    else メールアドレスが利用可能
        DB-->>API: 重複なし
        API->>API: パスワードをハッシュ化
        API->>DB: ユーザーデータを保存
        DB-->>API: 保存成功
        API->>API: アクセストークン生成
        API->>API: リフレッシュトークン生成
        API-->>Client: 201 Created<br/>{accessToken, refreshToken, user}
        Client->>Client: トークンを保存<br/>(localStorage/Cookie)
        Client-->>User: 登録完了画面表示
    end
```

## 2. ログインフロー

登録済みユーザーがシステムにログインする際のフローです。

```mermaid
sequenceDiagram
    actor User as ユーザー
    participant Client as クライアント
    participant API as APIサーバー
    participant DB as データベース

    User->>Client: 認証情報入力<br/>(メール、パスワード)
    Client->>Client: バリデーション
    Client->>API: POST /api/auth/login<br/>{email, password}
    
    API->>API: 入力検証
    API->>DB: メールアドレスでユーザー検索
    
    alt ユーザーが存在しない
        DB-->>API: ユーザーなし
        API-->>Client: 401 Unauthorized<br/>{error: "Invalid credentials"}
        Client-->>User: エラー表示
    else ユーザーが存在
        DB-->>API: ユーザー情報
        API->>API: パスワード検証
        
        alt パスワードが不一致
            API-->>Client: 401 Unauthorized<br/>{error: "Invalid credentials"}
            Client-->>User: エラー表示
        else パスワードが一致
            API->>API: アクセストークン生成
            API->>API: リフレッシュトークン生成
            API->>DB: リフレッシュトークンを保存
            DB-->>API: 保存成功
            API-->>Client: 200 OK<br/>{accessToken, refreshToken, user}
            Client->>Client: トークンを保存<br/>(localStorage/Cookie)
            Client-->>User: ログイン成功<br/>ホーム画面へ遷移
        end
    end
```

## 3. ログアウトフロー

ログイン中のユーザーがシステムからログアウトする際のフローです。

```mermaid
sequenceDiagram
    actor User as ユーザー
    participant Client as クライアント
    participant API as APIサーバー
    participant DB as データベース

    User->>Client: ログアウトボタンをクリック
    Client->>API: POST /api/auth/logout<br/>Authorization: Bearer {accessToken}<br/>{refreshToken}
    
    API->>API: アクセストークン検証
    
    alt トークンが無効
        API-->>Client: 401 Unauthorized<br/>{error: "Invalid token"}
        Client->>Client: ローカルトークン削除
        Client-->>User: ログイン画面へ遷移
    else トークンが有効
        API->>DB: リフレッシュトークンを無効化<br/>(削除またはブラックリスト化)
        DB-->>API: 無効化成功
        API-->>Client: 200 OK<br/>{message: "Logged out successfully"}
        Client->>Client: トークンを削除<br/>(localStorage/Cookie)
        Client-->>User: ログイン画面へ遷移
    end
```

## 4. 要認証APIでの認証フロー

保護されたAPIエンドポイントにアクセスする際の認証フローです。

```mermaid
sequenceDiagram
    actor User as ユーザー
    participant Client as クライアント
    participant API as APIサーバー
    participant DB as データベース

    User->>Client: 保護されたリソースにアクセス
    Client->>API: GET/POST/PUT/DELETE /api/protected/*<br/>Authorization: Bearer {accessToken}
    
    API->>API: アクセストークン検証
    
    alt トークンが無効または期限切れ
        API-->>Client: 401 Unauthorized<br/>{error: "Token expired"}
        
        Client->>Client: リフレッシュトークンを確認
        
        alt リフレッシュトークンあり
            Client->>API: POST /api/auth/refresh<br/>{refreshToken}
            API->>API: リフレッシュトークン検証
            API->>DB: リフレッシュトークン確認
            
            alt リフレッシュトークンが有効
                DB-->>API: トークン有効
                API->>API: 新しいアクセストークン生成
                API-->>Client: 200 OK<br/>{accessToken}
                Client->>Client: 新しいトークンを保存
                Client->>API: 元のリクエストを再送<br/>Authorization: Bearer {newAccessToken}
                API->>API: トークン検証成功
                API->>DB: リソースにアクセス
                DB-->>API: データ取得
                API-->>Client: 200 OK<br/>{data}
                Client-->>User: リソース表示
            else リフレッシュトークンが無効
                DB-->>API: トークン無効
                API-->>Client: 401 Unauthorized<br/>{error: "Please login again"}
                Client->>Client: トークンを削除
                Client-->>User: ログイン画面へ遷移
            end
        else リフレッシュトークンなし
            Client->>Client: トークンを削除
            Client-->>User: ログイン画面へ遷移
        end
    else トークンが有効
        API->>API: ユーザー情報を抽出
        API->>DB: リソースにアクセス
        DB-->>API: データ取得
        API-->>Client: 200 OK<br/>{data}
        Client-->>User: リソース表示
    end
```

## セキュリティ考慮事項

### トークンの保存

- **アクセストークン**: HTTPOnly Cookieまたはメモリ内に保存（XSS対策）
- **リフレッシュトークン**: HTTPOnly Cookieに保存（XSS対策）

### パスワードのハッシュ化

- bcryptまたはArgon2を使用してパスワードをハッシュ化
- ソルトを使用して同じパスワードでも異なるハッシュ値になるようにする

### トークンの有効期限

- アクセストークン: 短期間（15分〜1時間）
- リフレッシュトークン: 長期間（7日〜30日）

### HTTPS通信

- 本番環境では必ずHTTPSを使用してトークンを送信

### CSRF対策

- リフレッシュトークンをCookieに保存する場合、CSRFトークンを併用

## エンドポイント一覧

| メソッド | エンドポイント | 説明 | 認証 |
|---------|-------------|------|-----|
| POST | /api/auth/register | ユーザー登録 | 不要 |
| POST | /api/auth/login | ログイン | 不要 |
| POST | /api/auth/logout | ログアウト | 必要 |
| POST | /api/auth/refresh | トークンリフレッシュ | リフレッシュトークン |
| GET | /api/auth/me | 現在のユーザー情報取得 | 必要 |

## エラーコード

| コード | 説明 |
|-------|------|
| 400 | バリデーションエラー |
| 401 | 認証エラー（未認証、トークン無効） |
| 403 | 認可エラー（権限不足） |
| 409 | リソース競合 （メールアドレス重複など） |
| 500 | サーバーエラー |
